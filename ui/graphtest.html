<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Line graph test</title>
    <style type="text/css">

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-size: 11px;
        }
        .country-label {
            font-size: 11px;
            text-align: right;
        }

    </style>
</head>
<body>

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
        var width = 1000
        var height = 1000;
        var padding = 200;
        // For testing with a local Django installation
        //var apiBaseUrl = "http://localhost:8000/api/"

        var xScale = d3.scale.linear()
                .domain([1980, 2014])
                .range([padding, width - padding]);
        var yScale = d3.scale.linear()
                .domain([0, 100])
                .range([height - padding, padding]);

        // Create svg element
        var svg = d3.select("body")
                .append("svg")
                .attr({
                    width: width,
                    height: height,
                });

        // Separate container elements for countries and average allow us to keep average on top (at end)
        var countryContainer = svg.append("g");
        var averageContainer = svg.append("g");

        // create single element for average
        var average = averageContainer.append("g")
                .attr("class", "average");

        function calcAverage(coverage) {
            var total = 0;
            var count = 0;
            for (vacCode in coverage) {
                total += coverage[vacCode];
                count++;
            }
            return  total / count;
        }

        // Function to create spacing between labels
        // See https://www.safaribooksonline.com/blog/2014/03/11/solving-d3-label-placement-constraint-relaxing/
        var labelSpacing = 10;
        function relax(selector) {
            again = false;
            textLabels = countryContainer.selectAll(selector);
            textLabels.each(function (d, i) {
                a = this;
                da = d3.select(a);
                y1 = da.attr("y");
                textLabels.each(function (d, j) {
                    b = this;
                    if (a == b) return;

                    db = d3.select(b);
                    y2 = db.attr("y");
                    deltaY = y1 - y2;

                    if (Math.abs(deltaY) > labelSpacing) return;

                    again = true;
                    sign = deltaY > 0 ? 1 : -1;
                    adjust = sign * 2.0;
                    da.attr("y", +y1 + adjust);
                    db.attr("y", +y2 - adjust);
                });
            });

            if(again) {
                relax(selector);
                // to animate
                //setTimeout(relax,1);
            }
            else {
                // add lines from labels to graph lines
                /*
                countryContainer.selectAll(".country")
                        .append("line")
                        .attr({
                            "x1": padding - 17,
                            "x2": function(d) {
                                return d3.select(this.parentNode).select("path").node().getPointAtLength(0).x - 3;
                            },
                            "y1": function(d) {
                                return d3.select(this.parentNode).select("text").attr("y");
                            },
                            "y2": function(d) {
                                return d3.select(this.parentNode).select("path").node().getPointAtLength(0).y;
                            },
                            "stroke": "orange"
                        })
                */
            }
        }

        var lineFunction = d3.svg.line()
                .x(function(d) { return xScale(d["year"]); })
                // This is what we'd do to fetch values for a single vaccine:
                //.y(function(d) { return  yScale(d["coverage"]["DTP1"]); })
                //.defined(function(d) { return "DTP1" in d["coverage"]; })
                // And here's what we do to get the average value for all vaccines:
                .y(function(d) {
                    var coverage = d["coverage"];
                    return  yScale(calcAverage(coverage));
                })
                .defined(function(d) { return !$.isEmptyObject(d["coverage"]); })
                .interpolate("bundle");

        $.getJSON( apiBaseUrl + "fetch/coverage/dpt/", function( data ) {

            // create country groups
            var countries = countryContainer.selectAll(".country")
                    .data(data["countries"])
                    .enter()
                    .append("g")
                    .attr("class", "country");

            // add country lines
            countries
                    .append("path")
                    .attr("d", function(d){return lineFunction(d["years"]);})
                    .attr("stroke", "lightgrey")
                    .attr("stroke-width", 1)
                    .attr("fill", "none");

            // add left country labels
            countries
                    .append("text")
                    .attr({
                        "y": function(d){
                            return d3.select(this.parentNode).select("path").node().getPointAtLength(0).y;
                        },
                        "x": padding - 20,
                        "text-anchor": "end",
                        "class": "country-label country-label-start"
                    })
                    .text(function(d) { return d["name"]; });

            // add right country labels
            countries
                    .append("text")
                    .attr({
                        "y": function(d){
                            var path = d3.select(this.parentNode).select("path").node();
                            return path.getPointAtLength(path.getTotalLength()).y;
                        },
                        "x": width - padding + 20,
                        "class": "country-label country-label-end"
                    })
                    .text(function(d) { return d["name"]; });


            relax(".country-label-start");
            relax(".country-label-end");

            // average line
            average
                    .datum(data["average_years"])
                    .append("path")
                    .attr("d", function(d){return lineFunction(d);})
                    .attr("stroke", "black")
                    .attr("stroke-width", 2)
                    .attr("fill", "none");


            // Create axes
            var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(d3.format("d"));

            // Add axes
            svg.append("g")
                    .attr({
                        id: "x-axis",
                        class: "axis",
                        transform: "translate(0," + (height - padding) + ")",
                    })
                    .call(xAxis);

        });
    </script>

</body>
</html>